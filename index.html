<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>FlipBook Demo</title>
    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            background: #000;
            overflow: hidden;
        }

        /* èƒŒæ™¯å±‚ */
        .bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* object-fit: cover; */
            object-position: center;
            pointer-events: none;
            opacity: 1;
            z-index: 0;
            filter: blur(0px);
            transition: filter 1s ease;
        }

        .bg.blur {
            filter: blur(2px);
        }

        .bgframe {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 1;
            z-index: 2000;
        }

        #book-frame {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            z-index: 10;
            pointer-events: none;
            transition: transform 1.2s ease;
        }

        #book-wrapper {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            pointer-events: auto;
        }

        .stage {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: visible;
            z-index: 1;
        }

        /* â­ ç¿»é¡µ + ç¿»é¢å…¬ç”¨åŸºç¡€ */
        .page {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transform-origin: 50% 0%;
            transition: transform var(--duration) ease-in-out;
            will-change: transform;
            backface-visibility: hidden;
            transform-style: preserve-3d;
        }

        .page:hover {
            filter: drop-shadow(0px 6px 12px rgba(0, 0, 0, 0.25));
        }

        @keyframes shake {
            0%   { filter: drop-shadow(5px 0px 5px rgba(0,0,0,0.2)); }
            25%  { filter: drop-shadow(-5px 0px 5px rgba(0,0,0,0.2)); }
            50%  { filter: drop-shadow(5px 0px 5px rgba(0,0,0,0.2)); }
            75%  { filter: drop-shadow(-5px 0px 5px rgba(0,0,0,0.2)); }
            100% { filter: drop-shadow(5px 0px 5px rgba(0,0,0,0.2)); }
        }

        /* front æ­£é¢ */
        .page .front {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
        }

        /* back èƒŒé¢ */
        .page .back {
            position: absolute;
            width: 100%;
            height: 100%;
            transform: rotateY(180deg);
            backface-visibility: hidden;
        }

        .page img {
            display: block;
            height: 85vh;
            object-fit: contain;
            user-select: none;
            pointer-events: none;
        }

        /* ğŸ“˜ ç¿»é¡µ (ä½ åŸæ¥çš„æ•ˆæœ) */
        .page.flipped {
            transform: translate(-50%, calc(-50% - var(--lift))) rotate(var(--angle));
        }

        /* ğŸ“• å•é¡µç¿»é¢ï¼ˆrotateY180Â°ï¼‰ */
        .page.face-flipped {
            transform: translate(-50%, -50%) rotateY(180deg);
        }

        /* ğŸ”¥ æµ®åŠ¨ emoji é»˜è®¤éšè— */
        .floating-container {
            display: none;
        }

        .floating-container.floating-visible {
            display: block;
        }

        /* ğŸ”™ è¿”å›æŒ‰é’® */
        #reset-btn {
            position: fixed;
            left: 8%;
            top: 32%;
            z-index: 3000;
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.2);
            border: 0px solid #fff;
            border-radius: 8px;
            color: rgb(255, 54, 148);
            font-size: 36px;
            cursor: pointer;
            user-select: none;
            display: none;
            font-family: "Gill Sans", "Gill Sans MT", Calibri, sans-serif;
        }

        #next-btn {
            position: fixed;
            left: 13%;
            top: 55%;
            z-index: 3000;
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.2);
            border: 0px solid #fff;
            border-radius: 8px;
            color: rgb(255, 54, 148);
            font-size: 36px;
            cursor: pointer;
            user-select: none;
            display: none;
            font-family: "Gill Sans", "Gill Sans MT", Calibri, sans-serif;
        }

        /* âœ¨ å•é¡µç¿»é¢æŒ‰é’® */
        #flip-page-btn {
            position: fixed;
            left: 0%;
            top: 50%;
            transform: translate(-50%, -50%); /* å®Œç¾å±…ä¸­ */
            z-index: 5000;

            width: 10px;   /* å¯è‡ªå®šä¹‰å®½åº¦ */
            height: 70%;   /* å¯è‡ªå®šä¹‰é«˜åº¦ */

            background: transparent; /* ä¸æ˜¾ç¤ºèƒŒæ™¯ */
            border: none;            /* ä¸æ˜¾ç¤ºè¾¹æ¡† */
            color: transparent;      /* ä¸æ˜¾ç¤ºæ–‡å­— */

            opacity: 0.5;              /* å®Œå…¨ä¸å¯è§ï¼Œä½†ä»å¯ç‚¹å‡» */

            cursor: pointer;
            user-select: none;
        }

        /* #flip-page-btn:hover {
            background: rgba(255, 255, 255, 0.35);
        } */

        /* ğŸŒŸ æ–°å¢ï¼šå¡ç‰Œåˆ—è¡¨ Grid å®¹å™¨ */
        #grid-layout {
            position: fixed;
            width: 70vw;
            height: 80vh;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transform-style: preserve-3d;
            display: none;
            overflow-y: scroll;
            overflow-x: scroll;
            z-index: 2000;
            padding: 20px;
            background: rgba(0, 0, 0, 0);
            border-radius: 12px;
        }

        #grid-layout .page img {
            height: 40vh;
            object-fit: contain;
        }

        /* ğŸŒŸ å¡ç‰‡æ·¡å…¥åŠ¨ç”» */
        .grid-item {
            opacity: 0;
            transition: opacity 3.0s ease, transform 0.6s ease;
        }

        .grid-item.show {
            opacity: 1;
            transition: opacity 3.0s ease, transform 0.6s ease;
        }

        /* ğŸŒŸ å¡ç‰Œåˆ—è¡¨æŒ‰é’® */
        #grid-btn {
            position: fixed;
            right: 8%;
            top: 28%;
            z-index: 3000;
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.2);
            border: 0px solid #fff;
            border-radius: 8px;
            color: rgb(255, 54, 148);
            font-size: 28px;
            cursor: pointer;
            user-select: none;
            display: block;
            font-family: "Gill Sans", "Gill Sans MT", Calibri, sans-serif;
        }

        #grid-btn:hover {
            background: rgba(255, 255, 255, 0.35);
        }
    </style>
</head>

<body>

    <button id="reset-btn">Back</button>
    <button id="next-btn">Next</button>
    <button id="flip-page-btn">flip current page</button>
    <button id="grid-btn">Library</button>

    <div id="book-frame">
        <div id="book-wrapper">
            <div class="stage" id="stage"></div>
        </div>
    </div>

    <div id="grid-layout"></div>

    <img class="bg" src="imgs/bg_0.png" alt="èƒŒæ™¯å›¾" />
    <img class="bgframe" src="imgs/bg_1.png" alt="èƒŒæ™¯å›¾" />

    <script type="module">
        import { FlipBook } from './flipbook.js';
        import { FloatingEmojis } from './floatingEmojis.js';
        import { FloatingImages } from './floatingImages.js';
        import { EmojiPath } from './emojiPath.js';

        const stage = document.getElementById('stage');
        const frame = document.getElementById('book-frame');
        const wrapper = document.getElementById('book-wrapper');
        const bg = document.querySelector('.bg');
        const resetBtn = document.getElementById("reset-btn");
        const nextBtn = document.getElementById("next-btn");
        const flipPageBtn = document.getElementById("flip-page-btn");
        const gridBtn = document.getElementById("grid-btn");
        const gridLayout = document.getElementById("grid-layout");

        const book = new FlipBook(stage, { angle: 80, lift: 180, duration: 800 });
        const imgCount = 12;
        const images = Array.from({ length: imgCount }, (_, i) => `imgs/${i + 1}f.png`);
        const backfaces = Array.from({ length: imgCount }, (_, i) => `imgs/${i + 1}b.png`);
        let onTable = true;

        frame.style.transition = "none";
        await book.loadImages(images);
        await book.loadBackfaces(backfaces);

        function setInitialPose() {
            frame.style.transform = `
                translate(310px, 20px)
                scale(0.5)
                rotateX(40deg)
                rotateZ(-5deg)
                perspective(820px)
            `;
            onTable = true;
        }
        setInitialPose();

        requestAnimationFrame(() => {
            frame.style.transition = "transform 1.2s ease";
        });

        /* =====================================================
              â­ å•é¡µç¿»é¢
        ===================================================== */
        // flipPageBtn.addEventListener("click", () => {
        //     const idx = book.getCurrentPage();
        //     book.toggleFace(idx);
        // });

        for (let i = 0; i < book.pages.length; i++) {
            book.pages[i].addEventListener("click", () => {
                if (layoutMode === "grid" || onTable) return;
                const idx = book.getCurrentPage();
                book.toggleFace(idx);
            });
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        for (let i = 0; i < book.backfaces.length; i++) {
            book.backfaces[i].addEventListener("click", async () => {
                if (onTable) return;

                if (layoutMode === "grid") {
                    switchToBook();

                    // æ‰‡å½¢å±•å¼€æ•ˆæœï¼ˆ0.1 ç§’é—´éš”ç¿»é¡µï¼‰
                    // await delay(50);
                    for (let j = 0; j < i; j++) {
                        await delay(50);  // 100ms = 0.1s
                        book.flipNext();
                    }
                } else {
                    const idx = book.getCurrentPage();
                    book.toggleFace(idx);
                }
            });
        }


        /* =====================================================
              ğŸ‰ Floating Emoji
        ===================================================== */
        const emojiList = [
            "áƒš(à² ç›Šà² )áƒš", "(à²  Ê–Ì¯ à² )", "(ëˆˆ_ëˆˆ)", "(Â¬ç›ŠÂ¬)", "(à² â€¿â†¼)", "(Â¬_Â¬)", "(à² oà² )",
            "(Ø¹Ê˜Ğ”Ê˜)", "Ê•Ê˜â€¿Ê˜Ê”", "(ãƒà² ç›Šà² )ãƒå½¡â”»â”â”»", "Ù©(â•¬Ê˜ç›ŠÊ˜â•¬)Û¶", "(Ë˜ã……Ë˜)â™¡",
            "Ù©(Âºà±ªÂº)Û¶", "(â€¢Ï‰â€¢à¸…)", "(à¹‘>á´—<à¹‘)â™¡", "Ê•à² á´¥à² Ê”", "ã…‡ã……ã…‡", "(â•¬ç›Šà² )", "(à²¥Tà²¥)",
            "(Ù©(ï½¡â€¢Ìâ€¿â€¢Ì€ï½¡)Û¶)", "(ï¿£ï¸¶ï¿£)", "(ã¥ï¿£ Â³ï¿£)ã¥", "(ï½¡â™¡â€¿â™¡ï½¡)", "(Ê˜â€¿Ê˜)", "(â€¢á´—â€¢)Ùˆ Ì‘Ì‘",
            "áƒš(à² ç›Šà² )áƒš", "(à²  Ê–Ì¯ à² )", "(ëˆˆ_ëˆˆ)", "(Â¬ç›ŠÂ¬)", "(à² â€¿â†¼)", "(Â¬_Â¬)", "(à² oà² )",
            "(Ø¹Ê˜Ğ”Ê˜)", "Ê•Ê˜â€¿Ê˜Ê”", "(ãƒà² ç›Šà² )ãƒå½¡â”»â”â”»", "Ù©(â•¬Ê˜ç›ŠÊ˜â•¬)Û¶", "(Ë˜ã……Ë˜)â™¡",
            "Ù©(Âºà±ªÂº)Û¶", "(â€¢Ï‰â€¢à¸…)", "(à¹‘>á´—<à¹‘)â™¡", "Ê•à² á´¥à² Ê”", "ã…‡ã……ã…‡", "(â•¬ç›Šà² )", "(à²¥Tà²¥)",
            "(Ù©(ï½¡â€¢Ìâ€¿â€¢Ì€ï½¡)Û¶)", "(ï¿£ï¸¶ï¿£)", "(ã¥ï¿£ Â³ï¿£)ã¥", "(ï½¡â™¡â€¿â™¡ï½¡)", "(Ê˜â€¿Ê˜)", "(â€¢á´—â€¢)Ùˆ Ì‘Ì‘"
        ];

        const FE = new FloatingEmojis({
            count: 80,
            floatRange: 25,
            repelRadius: 160,
            speed: 0.5,
            emojis: emojiList
        });

        const floatingContainer = FE.container;
        floatingContainer.classList.add("floating-container");

        /* =====================================================
              ç‚¹å‡»ä¹¦ â†’ è¿›å…¥æ¨¡å¼
        ===================================================== */
        wrapper.addEventListener("click", () => {
            if (layoutMode === "grid") return;

            frame.style.transform = `
                translate(calc(50vw - 50%), calc(50vh - 50%))
                scale(1)
                rotateX(0deg)
                rotateY(0deg)
                perspective(1200px)
            `;
            bg.classList.add("blur");
            floatingContainer.classList.add("floating-visible");
            resetBtn.style.display = "block";
            nextBtn.style.display = "block";
            onTable = false;
        });

        /* =====================================================
              è¿”å›æŒ‰é’®
        ===================================================== */
        resetBtn.addEventListener("click", () => {
            const currentPage = book.getCurrentPage();
            if(currentPage > 0)
            {
                book.unflipLast();
            }
            else
            {
                setInitialPose();
                bg.classList.remove("blur");
                floatingContainer.classList.remove("floating-visible");
                resetBtn.style.display = "none";
                nextBtn.style.display = "none";
            }
        });
        nextBtn.addEventListener("click", () => {
            book.flipNext();
        });

        /* =====================================================
              emojiPath ä¿æŒä¸åŠ¨
        ===================================================== */
        const emojiPath = [...emojiList];
        await delay(500); // ç­‰å¾… FlipBook åˆå§‹åŒ–å®Œæˆ
        new EmojiPath({
            flipbook: book,
            pageIndex: 0,
            svgUrl: "./output3.svg",
            emojis: emojiPath,
            speed: 50,
            size: 120,
            scalePercent: 0.65,
            eyeLeft : 'à²¥',
            eyeRight : 'à²¥',
            mouth : 'T',
            color : "#b62c6fff",
        });

        new EmojiPath({
            flipbook: book,
            pageIndex: 1,
            svgUrl: "./output4.svg",
            emojis: emojiPath,
            speed: 50,
            size: 120,
            scalePercent: 0.6,
            eyeLeft : 'à¹',
            eyeRight : 'Ã²',
            mouth : 'ç›Š',
            color : "#634be0ff",
            eyeLeftPos : { x: 0.35, y: 0.42 },
            eyeRightPos : { x: 0.55, y: 0.42 },
            mouthPos : { x: 0.45, y: 0.5 }
        });

        new EmojiPath({
            flipbook: book,
            pageIndex: 2,
            svgUrl: "./output5.svg",
            emojis: emojiPath,
            speed: 50,
            size: 100,
            scalePercent: 0.7,
            eyeLeft : 'å›§',
            eyeRight : 'å›§',
            mouth : 'ã…‡ã……ã…‡',
            color : "#fdff69ff",
            eyeLeftPos : { x: 0.4, y: 0.45 },
            eyeRightPos : { x: 0.6, y: 0.45 },
            mouthPos : { x: 0.5, y: 0.5 }
        }); 

        new EmojiPath({
            flipbook: book,
            pageIndex: 3,
            svgUrl: "./output6.svg",
            emojis: emojiPath,
            speed: 50,
            size: 100,
            scalePercent: 0.6,
            color : "#496effff",
            eyeLeft : 'ëˆˆ',
            eyeRight : 'ëˆˆ',
            mouth : '_',
        });

        new EmojiPath({
            flipbook: book,
            pageIndex: 4,
            svgUrl: "./output7.svg",
            emojis: emojiPath,
            speed: 50,
            size: 100,
            scalePercent: 0.5,
            color : "#81f2ffff",
            eyeLeft : 'à² ',
            eyeRight : 'â†¼',
            mouth : 'â€¿',
            // eyeLeft : 'àº§',
            // eyeRight : 'àº§',
            // mouth : 'Ê˜',
        });

        new EmojiPath({
            flipbook: book,
            pageIndex: 5,
            svgUrl: "./output8.svg",
            emojis: emojiPath,
            speed: 50,
            size: 100,
            scalePercent: 0.6,
            color : "#634be0ff",
            eyeLeftPos : { x: 0.4, y: 0.5 },
            eyeRightPos : { x: 0.6, y: 0.5 },
            mouthPos : { x: 0.5, y: 0.56 },
            eyeLeft : 'à¹•',
            eyeRight : 'à¹•',
            mouth : 'â€¿',
        });

        new EmojiPath({
            flipbook: book,
            pageIndex: 6,
            svgUrl: "./output9.svg",
            emojis: emojiPath,
            speed: 50,
            size: 100,
            scalePercent: 0.6,
            color : "#fdff69ff",
            eyeLeft : 'à² ',
            eyeRight : 'à² ',
            mouth : 'o',            
        });

        new EmojiPath({
            flipbook: book,
            pageIndex: 7,
            svgUrl: "./output10.svg",
            emojis: emojiPath,
            speed: 50,
            size: 100,
            scalePercent: 0.6,
            color : "#c3ff8bff",
            eyeLeft : 'à¤•',
            eyeRight : 'à¤•',
            mouth : 'ï¸µ', 
        });

        new EmojiPath({
            flipbook: book,
            pageIndex: 8,
            svgUrl: "./output11.svg",
            emojis: emojiPath,
            speed: 50,
            size: 100,
            scalePercent: 0.6,
            color : "#b0cfffff",
            eyeLeft : 'Âº',
            eyeRight : 'Âº',
            mouth : 'à±ª', 
        });

        new EmojiPath({
            flipbook: book,
            pageIndex: 9,
            svgUrl: "./output12.svg",
            emojis: emojiPath,
            speed: 50,
            size: 100,
            scalePercent: 0.6,
            color : "#ffccfcff",
            eyeLeft : 'Â¬',
            eyeRight : 'Â¬',
            mouth : '_', 
        });

        new EmojiPath({
            flipbook: book,
            pageIndex: 10,
            svgUrl: "./output13.svg",
            emojis: emojiPath,
            speed: 50,
            size: 100,
            scalePercent: 0.6,
            color : "#81f2ffff",
            eyeLeft : 'ï½¡â€¢Ì',
            eyeRight : 'â€¢ï½¡',
            mouth : 'â€¿', 
        });

        new EmojiPath({
            flipbook: book,
            pageIndex: 11,
            svgUrl: "./output14.svg",
            emojis: emojiPath,
            speed: 50,
            size: 100,
            scalePercent: 0.6,
            color : "#7e4bffff",
            eyeLeft : 'áƒš',
            eyeRight : 'áƒš',
            mouth : 'â€¿', 
            eyeLeftPos : { x: 0.45, y: 0.45 },
            eyeRightPos : { x: 0.65, y: 0.45 },
            mouthPos : { x: 0.55, y: 0.52 }
        });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') book.flipNext();
            else if (e.key === 'ArrowRight') book.unflipLast();
        });

        /* =====================================================
              ğŸŒŸ æ–°å¢ï¼šGrid / Book æ¨¡å¼åˆ‡æ¢
        ===================================================== */
        let layoutMode = "book";

        function switchToGrid() {
            layoutMode = "grid";

            // frame.style.display = "none";
            gridLayout.style.display = "grid";
            gridLayout.style.gridTemplateColumns = "repeat(4, 1fr)";
            gridLayout.style.gridAutoRows = "auto";
            gridLayout.style.gap = "10px";

            gridLayout.innerHTML = "";

            while (book.flipped.length > 0)
                book.unflipLast();

            for (let i = 0; i < book.pages.length; i++) {
                book.flipFace(i);
            }


            book.backfaces.forEach(bf => {
                // bf.style.transform = "rotateY(180deg)";
                bf.style.position = "relative";
                // bf.style.left = "unset";
                // bf.style.top = "unset"; 
                bf.style.width = "240px";
                bf.style.height = "280px";
                // bf.style.margin = "100px";
                bf.classList.add("grid-item");
                gridLayout.appendChild(bf);

                requestAnimationFrame(() => {
                    bf.classList.add("show");
                });
            });
        }

        function switchToBook() {
            layoutMode = "book";

            gridLayout.style.display = "none";
            frame.style.display = "block";
            for (let i = 0; i < book.pages.length; i++) {
                book.unflipFace(i);
            }
            book.pages.forEach((pg, i) => {
                stage.appendChild(pg);

                pg.style = "";
                pg.style.zIndex = 1000 - i;
            });

            book.backfaces.forEach(bf => {
                stage.appendChild(bf);

                bf.style = "";
                bf.classList.remove("grid-item");
                requestAnimationFrame(() => {
                    bf.classList.remove("show");
                });
                bf.style.zIndex = 1000 - book.pages.indexOf(bf);
            });

            console.log(book.getCurrentPage());
            book.unflipFace(0);
            //setInitialPose();
        }

        gridBtn.addEventListener("click", () => {
            if (layoutMode === "book") switchToGrid();
            else switchToBook();
        });

    </script>

</body>

</html>